#!/home/savoirvi/bin/mksh

list="\
$(find src/ -type f -name '*.txt' -o -name '*.wshtml' \
| awk -F'/[^/]*$' '{print $1}' | sort -u | cut -d '/' -f 2- \
| while read dir; do
	edir="$(print $dir | sed -e 's/\//\\\//g')"
	if [ -f $dir/index.txt ] || [ -f $dir/index.wshtml ]; then
		printf '%s\n' "\<li\>\<a\ href\=\"\\/$edir\\/\"\>$(print $edir \
		| tr '-' ' ')\<\\/a\>\\<ul\>\\"
	else
		printf '%s' "\<li\>$(print $edir | tr '-' ' ')\\<ul\>"
	fi
	find src/$dir/ -maxdepth 1 -type f \( -name '*.txt' -o -name '*.wshtml' \) ! -name 'index.*' \
	| sort \
	| while read file; do
		t="$(printf '%s' "$file" | sed 's#.*/##')"
		printf '%s' "\\<li\>\<a\ href\=\"\\/$edir\\/"
		printf '%s' "$t" | sed -e 's/\.txt$/\.html/' -e 's/\.wshtml$/\.html/' -e 's/\ /\%20/'
		printf '%s\n' "\"\>$t\<\\/a\>\<\\/li\>\\"
	done
	printf '%s\n' "\<\\/ul\><\\/li\>\\"
done
)
"
# escape: $.*[\]^&/

menu="<div id=\"nav\">\\
<nav>\\
<ul>\\
$list<\\/ul>\\
<\\/nav>\\
<\\/div>\\
<div id=\"paper\">\\
<article>"

sed -e "s/<div>FOO<\/div>/$menu/" scripts/layout > includes/layout
